# Déploiement automatique sur Contabo (optionnel).
# Par défaut désactivé : pas besoin de configurer les secrets GitHub.
# Pour l'activer : décommenter "push" ci-dessous et ajouter les secrets VPS_SSH_*.

name: Deploy to Contabo VPS

on:
  workflow_dispatch:  # Déclenchement manuel depuis l'onglet Actions
  # push:
  #   branches:
  #     - main

jobs:
  deploy:
    name: Deploy COYA.PRO to Contabo
    runs-on: ubuntu-latest

    # IMPORTANT :
    # - Configurer un secret SSH privé : VPS_SSH_KEY
    # - Configurer l'utilisateur & le host du VPS : VPS_SSH_USER, VPS_SSH_HOST
    # - Optionnel : VPS_SSH_PORT (par défaut 22)

    env:
      VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
      VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          ssh-keyscan -p "${VPS_SSH_PORT:-22}" "$VPS_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy on VPS (docker compose + Odoo update)
        run: |
          SSH_PORT=${VPS_SSH_PORT:-22}
          ssh -p "$SSH_PORT" "$VPS_SSH_USER@$VPS_SSH_HOST" "bash -lc 'chmod +x /opt/COYA-SENEGEL/scripts/deploy_contabo.sh && /opt/COYA-SENEGEL/scripts/deploy_contabo.sh'"

